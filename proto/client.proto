syntax = "proto3";
package client;

import "error.proto";
import "model.proto";

option go_package = "github.com/connet-dev/connet/proto/pbclient";

message AuthenticateReq {
  string token = 1;
  bytes reconnect_token = 2;
  string build_version = 3;
  string metadata = 4;
}

message AuthenticateResp {
  error.Error error = 1;

  model.AddrPort public = 2;
  bytes reconnect_token = 3;
}

message Request {
  // Soft one-of
  Announce announce = 1;
  Relay relay = 2;

  message Announce {
    model.Endpoint endpoint = 1;
    model.Role role = 2;
    Peer peer = 3;
  }
  message Relay {
    model.Endpoint endpoint = 1;
    model.Role role = 2;
    bytes client_certificate = 3; // certificate to use when connecting to a relay
  }
}

message Response {
  error.Error error = 1;

  // Soft one-of if error is nil
  Announce announce = 2;
  Relays relay = 3;

  message Announce {
    repeated RemotePeer peers = 1;
  }
  message Relays {
    repeated Relay relays = 1;
    repeated DirectRelay directs = 2;
  }
}

message Peer {
  repeated model.AddrPort directs = 3;
  repeated string relay_ids = 6;
  bytes server_certificate = 4; // certificate to use when connecting to this client
  bytes client_certificate = 5; // certificate that this client uses when connecting
}

message RemotePeer {
  string id = 1; // peer id as assigned by the control server
  string metadata = 9;
  Peer peer = 8;
}

message Relay {
  string id = 3;
  repeated model.HostPort addresses = 4;
  bytes server_certificate = 2; // endpoint specific certificate to be used by the client
}

message DirectRelay {
  string id = 1; // relay id as assigned by the control server
  repeated model.HostPort addresses = 2;
  bytes server_certificate = 3; // generic certificate used by this relay
  bytes authentication_signature = 4; // endpoint/role specific signature to use at the relay
}
