syntax = "proto3";
package server;

import "shared.proto";

option go_package = "github.com/keihaya-com/connet/pbs";

message Authenticate {
  string token = 1;
}

message AuthenticateResp {
  shared.Error error = 1;

  shared.AddrPort public = 2;
}

message Request {
  // Soft one-of
  Relay relay = 1;
  Destination destination = 2;
  Source source = 3;

  message Relay {
    bytes certificate = 1; // certificate to use when connecting to a relay
    repeated shared.Forward destinations = 2;
    repeated shared.Forward sources = 3;
  }
  message Destination {
    shared.Forward from = 1;
    Peer peer = 2;
  }
  message Source {
    shared.Forward to = 1;
    Peer peer = 2;
  }
}

message Response {
  shared.Error error = 1;

  Relay relay = 2;
  Destination destination = 3;
  Source source = 4;

  message Relay {
    repeated Route relays = 1; // set of relay addresses that follow this server
  }
  message Destination {
    repeated Peer sources = 1;
  }
  message Source {
    repeated Peer destinations = 1;
  }
}

message Peer {
  repeated Route directs = 1;
  repeated Route relays = 2;
}

message Route {
  string hostport = 1;
  bytes certificate = 2;
}
