on:
  # workflow_run:
  #   workflows: [ci]
  #   types: [completed]
  #   branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (format: vX.Y.Z)"
        required: true
      upload:
        description: "Upload final artifacts to github"
        default: false
  push:
    branches: [releaseci] # remporary for testing
    # tags:
      # - "v[0-9]+.[0-9]+.[0-9]+"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  binary:
    name: Binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Build connet
        run: nix develop --command make all
      - name: Build release
        run: nix develop --command make release

  docker-x86:
    name: Docker x86
    runs-on: ubuntu-latest
    needs: [binary]
    steps:
      - uses: actions/checkout@v4
      - uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Docker build
        run: nix build .#docker

  docker-arm:
    name: Docker arm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: system = aarch64-linux
          nix_path: nixpkgs=channel:nixos-unstable
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - name: Docker build
        run: nix build .#docker
